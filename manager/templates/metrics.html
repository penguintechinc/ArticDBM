[[extend 'layout.html']]

[[block page_content]]
<div class="row mb-4">
    <div class="col-md-8">
        <h2>Real-Time Monitoring Dashboard</h2>
        <p class="text-muted">Live performance metrics and system monitoring for ArticDBM</p>
    </div>
    <div class="col-md-4 text-end">
        <div class="btn-group">
            <button class="btn btn-outline-primary" onclick="toggleAutoRefresh()">
                <i class="bi bi-arrow-clockwise" id="refreshIcon"></i> Auto-Refresh
            </button>
            <button class="btn btn-outline-secondary" onclick="exportMetrics()">
                <i class="bi bi-download"></i> Export
            </button>
            <button class="btn btn-outline-info" onclick="fullscreen()">
                <i class="bi bi-fullscreen"></i> Full Screen
            </button>
        </div>
    </div>
</div>

<!-- Key Performance Indicators -->
<div class="row mb-4">
    <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
        <div class="metric-card success">
            <div class="metric-value" id="totalQueries">0</div>
            <div class="metric-label">Total Queries</div>
            <small class="text-muted">Last 24h</small>
        </div>
    </div>
    <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
        <div class="metric-card info">
            <div class="metric-value" id="currentQPS">0</div>
            <div class="metric-label">Queries/Second</div>
            <small class="text-muted">Current rate</small>
        </div>
    </div>
    <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
        <div class="metric-card warning">
            <div class="metric-value" id="avgLatency">0ms</div>
            <div class="metric-label">Avg Latency</div>
            <small class="text-muted">P95: <span id="p95Latency">0ms</span></small>
        </div>
    </div>
    <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
        <div class="metric-card danger">
            <div class="metric-value" id="cacheHitRate">0%</div>
            <div class="metric-label">Cache Hit Rate</div>
            <small class="text-muted">All tiers</small>
        </div>
    </div>
    <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
        <div class="metric-card success">
            <div class="metric-value" id="activeConnections">0</div>
            <div class="metric-label">Active Connections</div>
            <small class="text-muted">Across all pools</small>
        </div>
    </div>
    <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
        <div class="metric-card danger">
            <div class="metric-value" id="errorRate">0%</div>
            <div class="metric-label">Error Rate</div>
            <small class="text-muted">Last hour</small>
        </div>
    </div>
</div>

<!-- Main Monitoring Charts -->
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Query Performance Over Time</h5>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary active" onclick="setTimeRange('1h')">1H</button>
                    <button class="btn btn-outline-primary" onclick="setTimeRange('6h')">6H</button>
                    <button class="btn btn-outline-primary" onclick="setTimeRange('24h')">24H</button>
                    <button class="btn btn-outline-primary" onclick="setTimeRange('7d')">7D</button>
                </div>
            </div>
            <div class="card-body">
                <canvas id="performanceChart" height="100"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Database Distribution</h5>
            </div>
            <div class="card-body">
                <canvas id="databaseDistributionChart" height="150"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Metrics Grid -->
<div class="row mb-4">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Cache Performance</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6">
                        <canvas id="cacheHitChart" height="120"></canvas>
                    </div>
                    <div class="col-6">
                        <div class="cache-stats">
                            <div class="d-flex justify-content-between mb-2">
                                <span>L1 Cache (Kernel)</span>
                                <div>
                                    <strong class="text-success">89.2%</strong>
                                    <small class="text-muted">256MB</small>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>L2 Cache (Redis)</span>
                                <div>
                                    <strong class="text-info">94.1%</strong>
                                    <small class="text-muted">2GB</small>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>L3 Cache (Backend)</span>
                                <div>
                                    <strong class="text-primary">97.3%</strong>
                                    <small class="text-muted">DB Native</small>
                                </div>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between">
                                <span><strong>Overall Hit Rate</strong></span>
                                <strong class="text-success">95.4%</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Security Events</h5>
            </div>
            <div class="card-body">
                <canvas id="securityChart" height="150"></canvas>
                <div class="mt-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>SQL Injection Attempts</span>
                        <span class="badge bg-danger">23</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Threat Intel Matches</span>
                        <span class="badge bg-warning">7</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Rate Limit Violations</span>
                        <span class="badge bg-info">12</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span>Authentication Failures</span>
                        <span class="badge bg-secondary">3</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- System Resources and Connection Pools -->
<div class="row mb-4">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">System Resources</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <span>CPU Usage</span>
                        <span class="text-warning">78%</span>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-warning" style="width: 78%"></div>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <span>Memory Usage</span>
                        <span class="text-info">64%</span>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-info" style="width: 64%"></div>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <span>Network I/O</span>
                        <span class="text-success">45%</span>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-success" style="width: 45%"></div>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <span>Disk I/O</span>
                        <span class="text-primary">32%</span>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-primary" style="width: 32%"></div>
                    </div>
                </div>

                <h6 class="mt-4">NUMA Node Status</h6>
                <div class="row">
                    <div class="col-6">
                        <div class="numa-node-status">
                            <small class="text-muted">Node 0</small>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-primary" style="width: 65%"></div>
                            </div>
                            <small class="text-muted">65% CPU, 8 workers</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="numa-node-status">
                            <small class="text-muted">Node 1</small>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-primary" style="width: 58%"></div>
                            </div>
                            <small class="text-muted">58% CPU, 8 workers</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Connection Pool Status</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Database</th>
                                <th>Active</th>
                                <th>Idle</th>
                                <th>Max</th>
                                <th>Utilization</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>MySQL Primary</strong></td>
                                <td><span class="badge bg-success">67</span></td>
                                <td><span class="badge bg-secondary">23</span></td>
                                <td>100</td>
                                <td>
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar bg-success" style="width: 67%"></div>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td><strong>MySQL Read Replica</strong></td>
                                <td><span class="badge bg-success">34</span></td>
                                <td><span class="badge bg-secondary">16</span></td>
                                <td>50</td>
                                <td>
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar bg-success" style="width: 68%"></div>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td><strong>PostgreSQL Analytics</strong></td>
                                <td><span class="badge bg-info">23</span></td>
                                <td><span class="badge bg-secondary">27</span></td>
                                <td>50</td>
                                <td>
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar bg-info" style="width: 46%"></div>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Redis Cache</strong></td>
                                <td><span class="badge bg-warning">12</span></td>
                                <td><span class="badge bg-secondary">8</span></td>
                                <td>20</td>
                                <td>
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar bg-warning" style="width: 60%"></div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="mt-3">
                    <h6>Pool Health</h6>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Connection Errors</span>
                        <span class="badge bg-danger">2</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Timeout Events</span>
                        <span class="badge bg-warning">5</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span>Pool Exhaustions</span>
                        <span class="badge bg-info">0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Real-time Event Log -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Real-Time Events</h5>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="liveEventsToggle" checked>
                    <label class="form-check-label" for="liveEventsToggle">Live Updates</label>
                </div>
            </div>
            <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                <div id="eventLog">
                    <div class="event-item">
                        <span class="timestamp">2024-01-15 14:23:45</span>
                        <span class="badge bg-success">INFO</span>
                        <span class="message">New connection established from 192.168.1.100</span>
                    </div>
                    <div class="event-item">
                        <span class="timestamp">2024-01-15 14:23:42</span>
                        <span class="badge bg-warning">WARN</span>
                        <span class="message">Query execution took longer than expected (2.5s)</span>
                    </div>
                    <div class="event-item">
                        <span class="timestamp">2024-01-15 14:23:38</span>
                        <span class="badge bg-danger">BLOCK</span>
                        <span class="message">SQL injection attempt blocked from IP 10.0.0.25</span>
                    </div>
                    <div class="event-item">
                        <span class="timestamp">2024-01-15 14:23:35</span>
                        <span class="badge bg-info">CACHE</span>
                        <span class="message">L1 cache hit for frequently accessed query</span>
                    </div>
                    <div class="event-item">
                        <span class="timestamp">2024-01-15 14:23:30</span>
                        <span class="badge bg-success">ML</span>
                        <span class="message">ML optimization suggested index on users.email</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
[[end]]

[[block page_scripts]]
<script>
let autoRefreshInterval;
let autoRefreshEnabled = false;

// Initialize all charts
$(document).ready(function() {
    initializeCharts();
    startRealTimeUpdates();
});

function initializeCharts() {
    // Performance Chart
    const perfCtx = document.getElementById('performanceChart').getContext('2d');
    window.performanceChart = new Chart(perfCtx, {
        type: 'line',
        data: {
            labels: generateTimeLabels(60), // Last 60 minutes
            datasets: [
                {
                    label: 'Queries/Second',
                    data: generateRandomData(60, 1000, 5000),
                    borderColor: 'rgb(52, 152, 219)',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    tension: 0.1,
                    yAxisID: 'y'
                },
                {
                    label: 'Avg Latency (ms)',
                    data: generateRandomData(60, 1, 10),
                    borderColor: 'rgb(231, 76, 60)',
                    backgroundColor: 'rgba(231, 76, 60, 0.1)',
                    tension: 0.1,
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Time'
                    }
                },
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Queries/Second'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Latency (ms)'
                    },
                    grid: {
                        drawOnChartArea: false,
                    },
                }
            }
        }
    });

    // Database Distribution Chart
    const dbCtx = document.getElementById('databaseDistributionChart').getContext('2d');
    new Chart(dbCtx, {
        type: 'doughnut',
        data: {
            labels: ['MySQL Primary', 'MySQL Replica', 'PostgreSQL', 'Redis', 'MongoDB'],
            datasets: [{
                data: [45, 25, 20, 7, 3],
                backgroundColor: [
                    'rgba(52, 152, 219, 0.8)',
                    'rgba(155, 89, 182, 0.8)',
                    'rgba(46, 204, 113, 0.8)',
                    'rgba(241, 196, 15, 0.8)',
                    'rgba(231, 76, 60, 0.8)'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // Cache Hit Chart
    const cacheCtx = document.getElementById('cacheHitChart').getContext('2d');
    new Chart(cacheCtx, {
        type: 'doughnut',
        data: {
            labels: ['L1 Hits', 'L2 Hits', 'L3 Hits', 'Cache Miss'],
            datasets: [{
                data: [45, 35, 15, 5],
                backgroundColor: [
                    'rgba(39, 174, 96, 0.8)',
                    'rgba(52, 152, 219, 0.8)',
                    'rgba(155, 89, 182, 0.8)',
                    'rgba(231, 76, 60, 0.8)'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });

    // Security Events Chart
    const secCtx = document.getElementById('securityChart').getContext('2d');
    new Chart(secCtx, {
        type: 'bar',
        data: {
            labels: ['SQL Injection', 'Threat Intel', 'Rate Limit', 'Auth Failure'],
            datasets: [{
                data: [23, 7, 12, 3],
                backgroundColor: [
                    'rgba(231, 76, 60, 0.8)',
                    'rgba(241, 196, 15, 0.8)',
                    'rgba(52, 152, 219, 0.8)',
                    'rgba(155, 89, 182, 0.8)'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function startRealTimeUpdates() {
    // Simulate real-time metric updates
    setInterval(updateMetrics, 2000);

    // Simulate live events
    setInterval(addLiveEvent, 5000);
}

function updateMetrics() {
    // Update KPI values
    document.getElementById('totalQueries').textContent = (Math.random() * 1000000 + 500000).toFixed(0);
    document.getElementById('currentQPS').textContent = (Math.random() * 3000 + 2000).toFixed(0);
    document.getElementById('avgLatency').textContent = (Math.random() * 5 + 2).toFixed(1) + 'ms';
    document.getElementById('p95Latency').textContent = (Math.random() * 10 + 5).toFixed(1) + 'ms';
    document.getElementById('cacheHitRate').textContent = (Math.random() * 5 + 92).toFixed(1) + '%';
    document.getElementById('activeConnections').textContent = (Math.random() * 100 + 400).toFixed(0);
    document.getElementById('errorRate').textContent = (Math.random() * 2).toFixed(2) + '%';

    // Update performance chart if auto-refresh is enabled
    if (autoRefreshEnabled) {
        const chart = window.performanceChart;
        if (chart) {
            // Add new data point
            chart.data.labels.push(new Date().toLocaleTimeString());
            chart.data.datasets[0].data.push(Math.random() * 3000 + 2000);
            chart.data.datasets[1].data.push(Math.random() * 5 + 2);

            // Remove old data point
            if (chart.data.labels.length > 60) {
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
                chart.data.datasets[1].data.shift();
            }

            chart.update('none');
        }
    }
}

function addLiveEvent() {
    if (!document.getElementById('liveEventsToggle').checked) return;

    const events = [
        { type: 'INFO', badge: 'bg-success', message: 'New connection established from ' + generateRandomIP() },
        { type: 'WARN', badge: 'bg-warning', message: 'Query execution took longer than expected' },
        { type: 'CACHE', badge: 'bg-info', message: 'L2 cache hit for complex analytics query' },
        { type: 'ML', badge: 'bg-success', message: 'ML optimization applied to slow query' },
        { type: 'BLOCK', badge: 'bg-danger', message: 'Suspicious activity blocked from IP ' + generateRandomIP() }
    ];

    const event = events[Math.floor(Math.random() * events.length)];
    const timestamp = new Date().toLocaleString();

    const eventHtml = `
        <div class="event-item">
            <span class="timestamp">${timestamp}</span>
            <span class="badge ${event.badge}">${event.type}</span>
            <span class="message">${event.message}</span>
        </div>
    `;

    const eventLog = document.getElementById('eventLog');
    eventLog.insertAdjacentHTML('afterbegin', eventHtml);

    // Keep only last 20 events
    const events_items = eventLog.children;
    if (events_items.length > 20) {
        eventLog.removeChild(events_items[events_items.length - 1]);
    }
}

function toggleAutoRefresh() {
    autoRefreshEnabled = !autoRefreshEnabled;
    const icon = document.getElementById('refreshIcon');

    if (autoRefreshEnabled) {
        icon.classList.add('fa-spin');
        autoRefreshInterval = setInterval(updateChartData, 5000);
        showSuccess('Auto-refresh enabled');
    } else {
        icon.classList.remove('fa-spin');
        clearInterval(autoRefreshInterval);
        showSuccess('Auto-refresh disabled');
    }
}

function setTimeRange(range) {
    // Update active button
    document.querySelectorAll('.btn-group .btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');

    // Update chart data based on time range
    let points, interval;
    switch(range) {
        case '1h': points = 60; interval = 1; break;
        case '6h': points = 72; interval = 5; break;
        case '24h': points = 96; interval = 15; break;
        case '7d': points = 168; interval = 60; break;
        default: points = 60; interval = 1;
    }

    // Regenerate chart data
    const chart = window.performanceChart;
    chart.data.labels = generateTimeLabels(points, interval);
    chart.data.datasets[0].data = generateRandomData(points, 1000, 5000);
    chart.data.datasets[1].data = generateRandomData(points, 1, 10);
    chart.update();
}

function exportMetrics() {
    showLoading();

    // Simulate metrics export
    setTimeout(() => {
        hideLoading();

        const data = {
            timestamp: new Date().toISOString(),
            metrics: {
                totalQueries: document.getElementById('totalQueries').textContent,
                currentQPS: document.getElementById('currentQPS').textContent,
                avgLatency: document.getElementById('avgLatency').textContent,
                cacheHitRate: document.getElementById('cacheHitRate').textContent
            }
        };

        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `articdbm-metrics-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        window.URL.revokeObjectURL(url);

        showSuccess('Metrics exported successfully');
    }, 1000);
}

function fullscreen() {
    if (document.fullscreenElement) {
        document.exitFullscreen();
    } else {
        document.documentElement.requestFullscreen();
    }
}

// Utility functions
function generateTimeLabels(count, intervalMinutes = 1) {
    const labels = [];
    const now = new Date();
    for (let i = count; i >= 0; i--) {
        const time = new Date(now.getTime() - (i * intervalMinutes * 60000));
        labels.push(time.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}));
    }
    return labels;
}

function generateRandomData(count, min, max) {
    const data = [];
    for (let i = 0; i < count; i++) {
        data.push(Math.random() * (max - min) + min);
    }
    return data;
}

function generateRandomIP() {
    return `${Math.floor(Math.random() * 255)}.${Math.floor(Math.random() * 255)}.${Math.floor(Math.random() * 255)}.${Math.floor(Math.random() * 255)}`;
}

// Styling
$('<style>').appendTo('head').html(`
    .event-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 0;
        border-bottom: 1px solid rgba(0,0,0,0.05);
        font-size: 0.9rem;
    }
    .event-item:last-child {
        border-bottom: none;
    }
    .event-item .timestamp {
        font-family: monospace;
        color: #6c757d;
        min-width: 150px;
    }
    .event-item .message {
        flex: 1;
    }
    .cache-stats {
        padding: 10px 0;
    }
    .numa-node-status {
        margin-bottom: 10px;
    }
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    .fa-spin {
        animation: spin 1s linear infinite;
    }
`);
</script>
[[end]]
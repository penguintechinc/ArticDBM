[[extend 'layout.html']]

[[block page_content]]
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h2>Cluster Management</h2>
            <div>
                <button class="btn btn-success" onclick="createCluster()">
                    <i class="bi bi-plus-circle"></i> Create Cluster
                </button>
                <button class="btn btn-info" onclick="importCluster()">
                    <i class="bi bi-cloud-download"></i> Import from Cloud
                </button>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <table class="table table-hover data-table">
                    <thead>
                        <tr>
                            <th>Cluster Name</th>
                            <th>Type</th>
                            <th>Role</th>
                            <th>Nodes</th>
                            <th>Features</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        [[for server in servers:]]
                        <tr>
                            <td>
                                <strong>[[=server.name]]</strong>
                                <br>
                                <small class="text-muted">[[=server.host]]:[[=server.port]]</small>
                            </td>
                            <td>
                                <span class="badge bg-primary">[[=server.type.upper()]]</span>
                            </td>
                            <td>
                                [[if server.role == 'read':]]
                                <span class="badge bg-info">
                                    <i class="bi bi-eye"></i> Read Only
                                </span>
                                [[elif server.role == 'write':]]
                                <span class="badge bg-warning">
                                    <i class="bi bi-pencil"></i> Write Only
                                </span>
                                [[else:]]
                                <span class="badge bg-success">
                                    <i class="bi bi-arrow-left-right"></i> Read/Write
                                </span>
                                [[pass]]
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" onclick="manageNodes([[=server.id]])">
                                    <i class="bi bi-diagram-3"></i> 1 Node
                                </button>
                            </td>
                            <td>
                                <div class="d-flex gap-1">
                                    [[if server.xdp_enabled if hasattr(server, 'xdp_enabled') else False:]]
                                    <span class="badge bg-success" title="XDP Acceleration Enabled">XDP</span>
                                    [[pass]]
                                    [[if server.is_galera if hasattr(server, 'is_galera') else False:]]
                                    <span class="badge bg-info" title="Galera Cluster">Galera</span>
                                    [[pass]]
                                    [[if server.ml_optimization if hasattr(server, 'ml_optimization') else False:]]
                                    <span class="badge bg-purple" title="ML Optimization">ML</span>
                                    [[pass]]
                                    [[if server.cache_enabled if hasattr(server, 'cache_enabled') else True:]]
                                    <span class="badge bg-secondary" title="Query Caching">Cache</span>
                                    [[pass]]
                                </div>
                            </td>
                            <td>
                                [[if server.is_active:]]
                                <span class="status-active">
                                    <i class="bi bi-check-circle"></i> Active
                                </span>
                                [[else:]]
                                <span class="status-inactive">
                                    <i class="bi bi-x-circle"></i> Inactive
                                </span>
                                [[pass]]
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="configureCluster([[=server.id]])"
                                            title="Configure">
                                        <i class="bi bi-gear"></i>
                                    </button>
                                    <button class="btn btn-outline-info" onclick="viewMetrics([[=server.id]])"
                                            title="Metrics">
                                        <i class="bi bi-graph-up"></i>
                                    </button>
                                    <button class="btn btn-outline-warning" onclick="editCluster([[=server.id]])"
                                            title="Edit">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="deleteCluster([[=server.id]])"
                                            title="Delete">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        [[pass]]
                        [[if not servers:]]
                        <tr>
                            <td colspan="7" class="text-center text-muted py-4">
                                <i class="bi bi-database-x display-4"></i>
                                <p class="mt-3">No clusters configured yet.</p>
                                <button class="btn btn-primary" onclick="createCluster()">
                                    <i class="bi bi-plus-circle"></i> Create Your First Cluster
                                </button>
                            </td>
                        </tr>
                        [[pass]]
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit Cluster Modal -->
<div class="modal fade" id="clusterModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="clusterModalTitle">Create Cluster</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="clusterForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Cluster Name</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Database Type</label>
                            <select class="form-select" name="type" onchange="updateTypeOptions(this.value)">
                                <option value="mysql">MySQL</option>
                                <option value="postgresql">PostgreSQL</option>
                                <option value="mssql">SQL Server</option>
                                <option value="mongodb">MongoDB</option>
                                <option value="redis">Redis</option>
                                <option value="sqlite">SQLite</option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label class="form-label">Host</label>
                            <input type="text" class="form-control" name="host" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Port</label>
                            <input type="number" class="form-control" name="port" value="3306" required>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Username</label>
                            <input type="text" class="form-control" name="username">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-control" name="password">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Node Role</label>
                            <select class="form-select" name="role">
                                <option value="both">Read/Write</option>
                                <option value="read">Read Only</option>
                                <option value="write">Write Only</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Weight (Load Balancing)</label>
                            <input type="number" class="form-control" name="weight" value="1" min="1" max="10">
                        </div>
                    </div>

                    <h6 class="mt-3">Advanced Features</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="galeraCheck" name="is_galera">
                                <label class="form-check-label" for="galeraCheck">
                                    Enable Galera Cluster Support
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="xdpCheck" name="xdp_enabled">
                                <label class="form-check-label" for="xdpCheck">
                                    Enable XDP/AF_XDP Acceleration
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="mlCheck" name="ml_optimization" checked>
                                <label class="form-check-label" for="mlCheck">
                                    Enable ML Query Optimization
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="cacheCheck" name="cache_enabled" checked>
                                <label class="form-check-label" for="cacheCheck">
                                    Enable Query Caching
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="auditCheck" name="audit_logging" checked>
                                <label class="form-check-label" for="auditCheck">
                                    Enable Audit Logging
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="sqlInjectionCheck" name="sql_injection_detection" checked>
                                <label class="form-check-label" for="sqlInjectionCheck">
                                    Enable SQL Injection Detection
                                </label>
                            </div>
                        </div>
                    </div>

                    <h6 class="mt-3">Connection Pool Settings</h6>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Max Connections</label>
                            <input type="number" class="form-control" name="max_connections" value="100" min="10" max="1000">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Min Connections</label>
                            <input type="number" class="form-control" name="min_connections" value="10" min="1" max="100">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Connection Timeout (s)</label>
                            <input type="number" class="form-control" name="connection_timeout" value="30" min="5" max="300">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveCluster()">Save Cluster</button>
            </div>
        </div>
    </div>
</div>
[[end]]

[[block page_scripts]]
<script>
function createCluster() {
    $('#clusterModalTitle').text('Create Cluster');
    $('#clusterForm')[0].reset();
    $('#clusterModal').modal('show');
}

function editCluster(id) {
    showLoading();
    $.get(`/api/database-servers/${id}`, function(data) {
        hideLoading();
        $('#clusterModalTitle').text('Edit Cluster');
        // Populate form with server data
        $('#clusterForm input[name="name"]').val(data.name);
        $('#clusterForm select[name="type"]').val(data.type);
        $('#clusterForm input[name="host"]').val(data.host);
        $('#clusterForm input[name="port"]').val(data.port);
        $('#clusterForm select[name="role"]').val(data.role);
        $('#clusterForm').data('cluster-id', id);
        $('#clusterModal').modal('show');
    });
}

function saveCluster() {
    const formData = $('#clusterForm').serialize();
    const clusterId = $('#clusterForm').data('cluster-id');

    showLoading();

    const url = clusterId ? `/api/database-servers/${clusterId}` : '/api/database-servers';
    const method = clusterId ? 'PUT' : 'POST';

    $.ajax({
        url: url,
        method: method,
        data: formData,
        success: function() {
            hideLoading();
            showSuccess('Cluster saved successfully');
            $('#clusterModal').modal('hide');
            setTimeout(() => location.reload(), 1500);
        },
        error: function() {
            hideLoading();
            showError('Failed to save cluster');
        }
    });
}

function deleteCluster(id) {
    confirmAction(
        'Delete Cluster?',
        'This action cannot be undone. All associated nodes and configurations will be removed.',
        function() {
            showLoading();
            $.ajax({
                url: `/api/database-servers/${id}`,
                method: 'DELETE',
                success: function() {
                    hideLoading();
                    showSuccess('Cluster deleted successfully');
                    setTimeout(() => location.reload(), 1500);
                },
                error: function() {
                    hideLoading();
                    showError('Failed to delete cluster');
                }
            });
        }
    );
}

function configureCluster(id) {
    window.location.href = `/clusters/${id}/settings`;
}

function manageNodes(id) {
    window.location.href = `/clusters/${id}/nodes`;
}

function viewMetrics(id) {
    window.location.href = `/monitoring/metrics?cluster=${id}`;
}

function importCluster() {
    Swal.fire({
        title: 'Import from Cloud Provider',
        html: `
            <select class="form-select mb-3" id="cloudProvider">
                <option value="">Select Provider</option>
                <option value="aws">AWS RDS</option>
                <option value="gcp">Google Cloud SQL</option>
                <option value="azure">Azure Database</option>
                <option value="kubernetes">Kubernetes</option>
            </select>
            <input type="text" class="form-control" id="cloudCredentials"
                   placeholder="Enter credentials or connection string">
        `,
        showCancelButton: true,
        confirmButtonText: 'Import',
        preConfirm: () => {
            const provider = document.getElementById('cloudProvider').value;
            const credentials = document.getElementById('cloudCredentials').value;
            if (!provider || !credentials) {
                Swal.showValidationMessage('Please select provider and enter credentials');
                return false;
            }
            return { provider, credentials };
        }
    }).then((result) => {
        if (result.isConfirmed) {
            showLoading();
            // Call import API
            setTimeout(() => {
                hideLoading();
                showSuccess('Cloud resources imported successfully');
            }, 2000);
        }
    });
}

function updateTypeOptions(type) {
    // Enable/disable options based on database type
    const galeraCheck = $('#galeraCheck');
    const sqlInjectionCheck = $('#sqlInjectionCheck');

    if (type === 'mysql') {
        galeraCheck.prop('disabled', false);
        $('#clusterForm input[name="port"]').val(3306);
    } else {
        galeraCheck.prop('disabled', true).prop('checked', false);

        if (type === 'postgresql') {
            $('#clusterForm input[name="port"]').val(5432);
        } else if (type === 'mongodb') {
            $('#clusterForm input[name="port"]').val(27017);
            sqlInjectionCheck.prop('disabled', true).prop('checked', false);
        } else if (type === 'redis') {
            $('#clusterForm input[name="port"]').val(6379);
            sqlInjectionCheck.prop('disabled', true).prop('checked', false);
        } else if (type === 'sqlite') {
            $('#clusterForm input[name="port"]').val(8765);
        }
    }
}
</script>
[[end]]